#include QMK_KEYBOARD_H
#include "version.h"

enum custom_keycodes {
  RGB_SLD = EZ_SAFE_RANGE,
  EPRM,
  DYNAMIC_MACRO_RANGE,
};
#include "dynamic_macro.h"

#define OS_CTL OSM(MOD_LCTL)
#define OS_SFT OSM(MOD_LSFT)
#define OS_GUI OSM(MOD_LGUI)
#define OS_ALT OSM(MOD_LALT)
#define MC_REC1 DYN_REC_START1
#define MC_PLY1 DYN_MACRO_PLAY1
#define MC_REC2 DYN_REC_START2
#define MC_PLY2 DYN_MACRO_PLAY2
#define MC_STOP DYN_REC_STOP
#define KC_PI LALT(KC_P)
#define MT_RSBS MT(MOD_LSFT, KC_BSLS)

#define BASE 0
#define RBSE 1
#define GAME 2
#define RGME 3
#define MOUS 4
#define RMUS 5
#define SYMB 6
#define RSMB 7

#define OS_RBSE OSL(RBSE)
#define OS_GAME OSL(GAME)
#define OS_RGME OSL(RGME)
#define OS_MOUS OSL(MOUS)
#define OS_RMUS OSL(RMUS)
#define OS_SYMB OSL(SYMB)
#define OS_RSMB OSL(RSMB)

#define _____________________BASE_L1___________________ KC_1    , KC_2    , KC_3    , KC_4    , KC_5
#define _____________________BASE_L2___________________ KC_Q    , KC_W    , KC_E    , KC_R    , KC_T
#define _____________________BASE_L3___________________ KC_A    , KC_S    , KC_D    , KC_F    , KC_G
#define _____________________BASE_L4___________________ KC_Z    , KC_X    , KC_C    , KC_V    , KC_B   
#define ________________BASE_L5______________           KC_GRV  , KC_QUOT , KC_LEFT , KC_RGHT

#define _____________________BASE_R1___________________ KC_6    , KC_7    , KC_8    , KC_9    , KC_0   
#define _____________________BASE_R2___________________ KC_Y    , KC_U    , KC_I    , KC_O    , KC_P   
#define _____________________BASE_R3___________________ KC_H    , KC_J    , KC_K    , KC_L    , KC_SCLN
#define _____________________BASE_R4___________________ KC_N    , KC_M    , KC_COMM , KC_DOT  , KC_SLSH   
#define           ________________BASE_R5______________           KC_DOWN , KC_UP   , KC_LBRC , KC_RBRC

#define _____________________GAME_L1___________________ KC_1    , KC_2    , KC_3    , KC_4    , KC_5    
#define _____________________GAME_L2___________________ KC_Q    , KC_W    , KC_E    , KC_R    , KC_T    
#define _____________________GAME_L3___________________ KC_A    , KC_S    , KC_D    , KC_F    , KC_G    
#define _____________________GAME_L4___________________ KC_Z    , KC_X    , KC_C    , KC_V    , KC_B    
#define ________________GAME_L5______________           KC_GRV  , KC_QUOT , KC_LALT , KC_LGUI 

#define _____________________GAME_R1___________________ KC_6    , KC_7    , KC_8    , KC_9    , KC_0    
#define _____________________GAME_R2___________________ KC_Y    , KC_U    , KC_I    , KC_O    , KC_P    
#define _____________________GAME_R3___________________ KC_H    , KC_J    , KC_K    , KC_L    , KC_SCLN 
#define _____________________GAME_R4___________________ KC_N    , KC_M    , KC_UP   , KC_COMM , KC_DOT  
#define           ________________GAME_R5______________           KC_LEFT , KC_DOWN , KC_RGHT , KC_RCTL 

#define ________________RGME_L5______________           KC_RCTL , KC_LEFT , KC_DOWN , KC_RGHT

#define _____________________MOUS_L1___________________ KC_F1   , KC_F2   , KC_F3   , KC_F4   , KC_F5   
#define _____________________MOUS_L2___________________ KC_F6   , KC_F7   , KC_F8   , KC_F9   , KC_F10  
#define _____________________MOUS_L3___________________ KC_F11  , KC_F12  , KC_F13  , KC_F14  , KC_F15  
#define _____________________MOUS_L4___________________ KC_F16  , KC_F17  , KC_F18  , KC_F19  , KC_F20  
#define ________________MOUS_L5______________           KC_F21  , KC_F22  , KC_F23  , KC_F24  

#define _____________________MOUS_R1___________________ KC_VOLD , KC_MPRV , KC_MPLY , KC_MNXT , KC_VOLU 
#define _____________________MOUS_R2___________________ MC_REC1 , MC_PLY1 , KC_MS_U , KC_MUTE , _______ 
#define _____________________MOUS_R3___________________ MC_STOP , KC_MS_L , KC_MS_D , KC_MS_R , _______ 
#define _____________________MOUS_R4___________________ MC_REC2 , MC_PLY2 , KC_WH_U , _______ , _______    
#define           ________________MOUS_R5______________           KC_WH_L , KC_WH_D , KC_WH_R , RESET   

#define           ________________RMUS_L5______________ RESET   , KC_WH_L , KC_WH_D , KC_WH_R 

#define ________________SYMB_L1______________ KC_AMPR , KC_PIPE , KC_EXLM , KC_EQL  
#define ________________SYMB_L2______________ KC_HASH , KC_PERC , KC_LCBR , KC_RCBR 
#define ________________SYMB_L3______________ KC_DLR  , KC_AT   , KC_LPRN , KC_RPRN 
#define ________________SYMB_L4______________ KC_TILD , KC_CIRC , KC_LBRC , KC_RBRC 
#define ________________SYMB_L5______________ KC_LABK , KC_PIPE , KC_MINS , KC_RABK 

#define _____________________SYMB_R1___________________ KC_PI   , KC_P7   , KC_P8   , KC_P9   , KC_PSLS 
#define _____________________SYMB_R2___________________ KC_CIRC , KC_P4   , KC_P5   , KC_P6   , KC_PAST 
#define _____________________SYMB_R3___________________ KC_EXLM , KC_P1   , KC_P2   , KC_P3   , KC_PMNS 
#define _____________________SYMB_R4___________________ KC_PEQL , KC_P0   , KC_COMM , KC_PDOT , KC_PPLS 

#define LAYOUT_ergodox_pretty_wrapper(...)   LAYOUT_ergodox_pretty(__VA_ARGS__)

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [BASE] = LAYOUT_ergodox_pretty_wrapper(
      KC_ESC  , _____________________BASE_L1___________________ , OS_GAME ,           OS_GAME , _____________________BASE_R1___________________ , KC_MINS ,
      KC_TAB  , _____________________BASE_L2___________________ , OS_MOUS ,           OS_MOUS , _____________________BASE_R2___________________ , KC_EQL  , 
      OS_CTL  , _____________________BASE_L3___________________ ,                               _____________________BASE_R3___________________ , KC_ENT  , 
      OS_SFT  , _____________________BASE_L4___________________ , OS_SYMB ,           OS_SYMB , _____________________BASE_R4___________________ , MT_RSBS ,
      OS_RBSE , ________________BASE_L5______________ ,                                                   ________________BASE_R5______________ , OS_RBSE , 
                                                        KC_INS  , KC_HOME ,           KC_PGUP , KC_DEL  , 
                                                                  KC_END  ,           KC_PGDN , 
                                              OS_GUI  , OS_ALT  , OS_RBSE ,           OS_RBSE , KC_BSPC , KC_SPC
     ) , 

  [RBSE] = LAYOUT_ergodox_pretty_wrapper(
      KC_MINS , _____________________BASE_R1___________________ , _______ ,           _______ , _____________________BASE_L1___________________ , KC_ESC  , 
      KC_EQL  , _____________________BASE_R2___________________ , _______ ,           _______ , _____________________BASE_L2___________________ , KC_TAB  , 
      KC_ENT  , _____________________BASE_R3___________________ ,                               _____________________BASE_L3___________________ , OS_CTL  , 
      MT_RSBS , _____________________BASE_R4___________________ , _______ ,           _______ , _____________________BASE_L4___________________ , OS_SFT  , 
      _______ , ________________BASE_R5______________ ,                                                   ________________BASE_L5______________ , _______ , 
                                                        KC_DEL  , KC_PGUP ,           KC_HOME , KC_INS  , 
                                                                  KC_PGDN ,           KC_END  ,
                                              KC_SPC  , KC_BSPC , _______ ,           _______ , OS_ALT  , OS_GUI
     ) , 

  [GAME] = LAYOUT_ergodox_pretty_wrapper(
      KC_ESC  , _____________________GAME_L1___________________ , _______ ,           _______ , _____________________GAME_R1___________________ , KC_MINS ,
      KC_TAB  , _____________________GAME_L2___________________ , _______ ,           _______ , _____________________GAME_R2___________________ , KC_EQL  ,
      KC_LCTL , _____________________GAME_L3___________________ ,                               _____________________GAME_R3___________________ , KC_BSLS ,
      KC_LSFT , _____________________GAME_L4___________________ , _______ ,           _______ , _____________________GAME_R4___________________ , KC_SLSH ,
      OS_RGME , ________________GAME_L5______________ ,                                                   ________________GAME_R5______________ , OS_RGME ,
                                                        KC_INS  , KC_HOME ,           KC_PGUP , KC_DEL  ,
                                                                  KC_END  ,           KC_PGDN ,
                                              KC_SPC  , KC_ENT  , KC_LBRC ,           KC_RBRC , KC_BSPC , KC_SPC
    ) , 

  [RGME] = LAYOUT_ergodox_pretty_wrapper(
      KC_MINS , _____________________GAME_R1___________________ , _______ ,           _______ , _____________________GAME_L1___________________ , KC_ESC  ,
      KC_EQL  , _____________________GAME_R2___________________ , _______ ,           _______ , _____________________GAME_L2___________________ , KC_TAB  ,
      KC_BSLS , _____________________GAME_R3___________________ ,                               _____________________GAME_L3___________________ , KC_LCTL ,
      KC_SLSH , _____________________GAME_R4___________________ , _______ ,           _______ , _____________________GAME_L4___________________ , KC_LSFT ,
      _______ , ________________RGME_L5______________ ,                                                   ________________GAME_L5______________ , _______ ,
                                                        KC_DEL  , KC_PGUP ,           KC_HOME , KC_INS  ,
                                                                  KC_PGDN ,           KC_END  ,
                                              KC_SPC  , KC_BSPC , KC_RBRC ,           KC_LBRC , KC_ENT , KC_SPC
    ) , 

  [MOUS] = LAYOUT_ergodox_pretty_wrapper(
      _______ , _____________________MOUS_L1___________________ , _______ ,           _______ , _____________________MOUS_R1___________________ , _______ ,
      _______ , _____________________MOUS_L2___________________ , _______ ,           _______ , _____________________MOUS_R2___________________ , _______ ,
      _______ , _____________________MOUS_L3___________________ ,                               _____________________MOUS_R3___________________ , _______ ,
      _______ , _____________________MOUS_L4___________________ , _______ ,           _______ , _____________________MOUS_R4___________________ , _______ ,
      OS_RMUS , ________________MOUS_L5______________ ,                                                   ________________MOUS_R5______________ , OS_RMUS ,
                                                        _______ , _______ ,           KC_BTN5 , _______ ,
                                                                  _______ ,           KC_BTN4 ,
                                              KC_ACL2 , KC_ACL1 , KC_ACL0 ,           KC_BTN3 , KC_BTN2 , KC_BTN1
    ) , 

  [RMUS] = LAYOUT_ergodox_pretty_wrapper(
      _______ , _____________________MOUS_R1___________________ , _______ ,           _______ , _____________________MOUS_L1___________________ , _______ ,
      _______ , _____________________MOUS_R2___________________ , _______ ,           _______ , _____________________MOUS_L2___________________ , _______ ,
      _______ , _____________________MOUS_R3___________________ ,                               _____________________MOUS_L3___________________ , _______ ,
      _______ , _____________________MOUS_R4___________________ , _______ ,           _______ , _____________________MOUS_L4___________________ , _______ ,
      _______ , ________________RMUS_L5______________ ,                                                   ________________MOUS_L5______________ , _______ ,
                                                        _______ , KC_BTN5 ,           _______ , _______ , 
                                                                  KC_BTN4 ,           _______ , 
                                              KC_BTN1 , KC_BTN2 , KC_BTN3 ,           KC_ACL0 , KC_ACL1 , KC_ACL2
    ) , 

  [SYMB] = LAYOUT_ergodox_pretty_wrapper(
      _______ , ________________SYMB_L1______________ , _______ , _______ ,           _______ , _____________________SYMB_R1___________________ , _______ ,
      _______ , ________________SYMB_L2______________ , _______ , _______ ,           _______ , _____________________SYMB_R2___________________ , _______ ,
      _______ , ________________SYMB_L3______________ , _______ ,                               _____________________SYMB_R3___________________ , _______ ,
      _______ , ________________SYMB_L4______________ , _______ , _______ ,           _______ , _____________________SYMB_R4___________________ , _______ ,
      OS_RSMB , ________________SYMB_L5______________ ,                                                   _______ , _______ , _______ , _______ , OS_RSMB ,
                                                        _______ , _______ ,           _______ , _______ ,
                                                                  _______ ,           _______ ,
                                              _______ , _______ , OS_RSMB ,           OS_RSMB , _______ , _______
    ),

  [RSMB] = LAYOUT_ergodox_pretty_wrapper(
      _______ , _____________________SYMB_R1___________________ , _______ ,           _______ , _______ , ________________SYMB_L1______________ , _______ ,
      _______ , _____________________SYMB_R2___________________ , _______ ,           _______ , _______ , ________________SYMB_L2______________ , _______ ,
      _______ , _____________________SYMB_R3___________________ ,                               _______ , ________________SYMB_L3______________ , _______ ,
      _______ , _____________________SYMB_R4___________________ , _______ ,           _______ , _______ , ________________SYMB_L4______________ , _______ ,
      _______ , _______ , _______ , _______ , _______ ,                                                   ________________SYMB_L5______________ , _______ ,
                                                        _______ , _______ ,           _______ , _______ ,
                                                                  _______ ,           _______ ,
                                              _______ , _______ , _______ ,           _______ , _______ , _______
    ) , 

};

extern bool g_suspend_state;
extern rgb_config_t rgb_matrix_config;

void keyboard_post_init_user(void) {
  rgb_matrix_enable();
}

const uint8_t PROGMEM ledmap[][DRIVER_LED_TOTAL][3] = {
  [BASE] = { 
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
                     {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},

    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
                     {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}
  },

  [RBSE] = { 
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
    {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
                     {200, 255, 255}, {200, 255, 255}, {200, 255, 255}, {200, 255, 255},
    
    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
    {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255},
                     {114, 255, 255}, {114, 255, 255}, {114, 255, 255}, {114, 255, 255}
  },

  [GAME] = { 
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {249, 228, 255}, {154, 255, 255}, {154, 255, 255},
                     {249, 228, 255}, {249, 228, 255}, {249, 228, 255}, {0,   0,   255},

    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {249, 228, 255}, {154, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {249, 228, 255}, {249, 228, 255}, {249, 228, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
                     {0,   0,   255}, {0,   0,   255}, {154, 255, 255}, {154, 255, 255}
  },

  [RGME] = { 
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {249, 228, 255}, {154, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {249, 228, 255}, {249, 228, 255}, {249, 228, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
                     {0,   0,   255}, {0,   0,   255}, {154, 255, 255}, {154, 255, 255},

    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {154, 255, 255}, {249, 228, 255}, {154, 255, 255}, {154, 255, 255},
                     {249, 228, 255}, {249, 228, 255}, {249, 228, 255}, {0,   0,   255}
  },

  [MOUS] = { 
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {141, 255, 233}, {141, 255, 233}, {141, 255, 233}, {141, 255, 233}, {141, 255, 233},
    {0,   0,   255}, {0,   0,   255}, {14,  255, 255}, {141, 255, 233}, {0,   0,   0},
    {0,   0,   255}, {14,  255, 255}, {14,  255, 255}, {14,  255, 255}, {0,   0,   0},  
    {0,   0,   255}, {0,   0,   255}, {30,  96,  255}, {0,   0,   0},   {0,   0,   0},  
                     {30,  96,  255}, {30,  96,  255}, {30,  96,  255}, {249, 228, 255},
   
    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252},
    {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252},
    {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252},
    {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252},
                     {13,  165, 252}, {13,  165, 252}, {13,  165, 252}, {13,  165, 252}
  },

  [RMUS] = {
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {21,  255, 255}, {21,  204, 254}, {21,  162, 250}, {21,  124, 246}, {21,  86,  252},
    {16,  255, 255}, {16,  207, 246}, {16,  165, 250}, {16,  119, 252}, {16,  79,  254},
    {13,  252, 250}, {13,  204, 250}, {13,  165, 252}, {13,  115, 250}, {13,  73,  250},
    {8,   255, 250}, {8,   204, 254}, {8,   167, 252}, {8,   121, 252}, {8,   79,  254},
                     {0,   210, 254}, {0,   173, 254}, {0,   135, 252}, {0,   98,  252},
    
    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {141, 255, 233}, {141, 255, 233}, {141, 255, 233}, {141, 255, 233}, {141, 255, 233},
    {0,   0,   0},   {141, 255, 233}, {14,  255, 255}, {0,   0,   255}, {0,   0,   255},
    {0,   0,   0},   {14,  255, 255}, {14,  255, 255}, {14,  255, 255}, {0,   0,   255},  
    {0,   0,   0},   {0,   0,   0},   {30,  96,  255}, {0,   0,   255}, {0,   0,   255},  
                     {30,  96,  255}, {30,  96,  255}, {30,  96,  255}, {249, 228, 255},
  },

  [SYMB] = { 
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
                     {0,   0,   0},   {0,   0,   0},   {0,   0,   0},   {0,   0,   0},
   
    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
                     {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255}
  },

  [RSMB] = { 
    /* * * * * * * * * * * * * * * * * Right hand --> * * * * * * * * * * * * * * * * */
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
    {0,   0,   0},   {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},
                     {154, 255, 255}, {154, 255, 255}, {154, 255, 255}, {154, 255, 255},

    /* * * * * * * * * * * * * * * * * <--- Left hand * * * * * * * * * * * * * * * * */
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
    {154, 255, 255}, {105, 255, 255}, {105, 255, 255}, {105, 255, 255}, {154, 255, 255},
                     {0,   0,   0},   {0,   0,   0},   {0,   0,   0},   {0,   0,   0}
  },
};

void set_layer_color(int layer) {
  for (int i = 0; i < DRIVER_LED_TOTAL; i++) {
    HSV hsv = {
      .h = pgm_read_byte(&ledmap[layer][i][0]),
      .s = pgm_read_byte(&ledmap[layer][i][1]),
      .v = pgm_read_byte(&ledmap[layer][i][2]),
    };
    if (!hsv.h && !hsv.s && !hsv.v) {
        rgb_matrix_set_color( i, 0, 0, 0 );
    } else {
        RGB rgb = hsv_to_rgb( hsv );
        float f = (float)rgb_matrix_config.hsv.v / UINT8_MAX;
        rgb_matrix_set_color( i, f * rgb.r, f * rgb.g, f * rgb.b );
    }
  }
}

void rgb_matrix_indicators_user(void) {
  if (g_suspend_state || keyboard_config.disable_layer_led) { return; }
  uint8_t layer = biton32(layer_state);
  if (layer >= 0 && layer <= 7) {
    set_layer_color(layer);
  } else {
    if (rgb_matrix_get_flags() == LED_FLAG_NONE) rgb_matrix_set_color_all(0, 0, 0);
  }
}

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  if (!process_record_dynamic_macro(keycode, record)) {
    return false;
  }
  switch (keycode) {
    case EPRM:
      if (record->event.pressed) {
        eeconfig_init();
      }
      return false;
    case RGB_SLD:
      if (record->event.pressed) {
        rgblight_mode(1);
      }
      return false;
  }
  return true;
}

void ledb(uint8_t led, bool on, uint8_t brightness) {
  switch (led) {
    case 1: OCR1A = brightness; break;
    case 2: OCR1B = brightness; break;
    case 3: OCR1C = brightness; break;
    default: break;
  }

  uint8_t led_mask = 1 << (4 + led);
  if (on) {
    DDRB |= led_mask;
    PORTB |= led_mask;
  } else {
    DDRB &= ~led_mask;
    PORTB &= ~led_mask;
  }
} 

void led(uint8_t led, bool on) {
  ledb(led, on, LED_BRIGHTNESS_HI);
}

void switch_layer_leds(uint32_t state) {
  uint8_t layer = biton32(state);
  led(1, false);
  led(2, false);
  switch (layer) {
    case 1: 
      ledb(1, true, 0);
      ledb(2, true, 0);
      break;
    case 2: 
      ledb(1, true, LED_BRIGHTNESS_LO);
      ledb(2, true, LED_BRIGHTNESS_LO);
      break;
    case 3: 
      led(1, true);
      led(2, true);
      break;
    case 4: 
      ledb(1, true, LED_BRIGHTNESS_LO);
      break;
    case 5: 
      led(1, true);
      break;
    case 6: 
      ledb(2, true, LED_BRIGHTNESS_LO);
      break;
    case 7: 
      led(2, true);
      break;
    default: 
      break;
  }
};

uint32_t layer_state_set_user(uint32_t state) {
  switch_layer_leds(state);

  return state;
};

uint8_t count_bits(uint8_t n) {
  unsigned int count = 0; 
  while (n) { 
    count += n & 1; 
    n >>= 1; 
  } 
  return count; 
}

void switch_mod_led(uint8_t mods) {
  uint8_t step = LED_BRIGHTNESS_HI / 8;

  ledb(3, !!mods, count_bits(mods) * step * 2);
};

// Runs constantly in the background, in a loop.
void matrix_scan_user(void) {
  switch_mod_led(keyboard_report->mods | get_oneshot_mods());
};
